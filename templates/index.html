<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Queueing Theory Calculator - M/M/2</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <script>
    window.MathJax = {
      tex: {inlineMath: [['\\(','\\)'], ['$', '$']]}
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- TAMBAHAN: Chart.js untuk grafik -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <main class="container">

    <header class="header-center">
      <h1 class="title">üßÆ Queueing Theory Calculator üßÆ</h1>
    </header>

    <section class="card">
      <div> <p style="text-align:center;"> Model: M/M/2 (dua pelayan) ‚Äî rumus standar Erlang-C. Semua input dalam menit. </p> </div>

      <h2>Input Data</h2>

      {% if error %}
        <div class="alert">{{ error }}</div>
      {% endif %}

      <form class="form" method="POST" action="/">
        <input type="hidden" name="tab" id="tabInput" value="{{ active_tab if active_tab else 'perhitungan' }}">

        <div class="grid">
          <label class="field">
            <span>Waktu antar kedatangan (menit)</span>
            <input type="number" name="interarrival" step="0.0001" min="0.0001"
                   value="{{ interarrival }}" required>
            <small>Contoh soal: 4 menit/pelanggan</small>
          </label>

          <label class="field">
            <span>Waktu pelayanan per pelayan (menit)</span>
            <input type="number" name="service_time" step="0.0001" min="0.0001"
                   value="{{ service_time }}" required>
            <small>Contoh soal: 3 menit/pelanggan</small>
          </label>
        </div>

        <label class="field">
          <span>Jumlah pelayan (server)</span>
          <select name="c" disabled>
            <option value="2" selected>2 (sesuai instruksi)</option>
          </select>
          <small>Untuk tugas ini ditetapkan M/M/2.</small>
        </label>

        <button class="btn" type="submit">Calculate</button>
      </form>

      {% if res %}
        <div class="divider"></div>

        <div class="tabs">
          <button type="button" class="tab-btn" id="btn-perhitungan" onclick="showTab('perhitungan')">
            Hasil Perhitungan
          </button>
          <button type="button" class="tab-btn" id="btn-ringkasan" onclick="showTab('ringkasan')">
            Hasil (M/M/2)
          </button>

          <!-- TAMBAHAN: tab grafik -->
          <button type="button" class="tab-btn" id="btn-grafik" onclick="showTab('grafik')">
            Grafik Simulasi
          </button>
        </div>

        <div id="tab-perhitungan" class="tab-panel">
          <h2>Hasil Perhitungan</h2>

          <div class="step">
            <h3>Proses Pengerjaan (Step-by-step)</h3>

            <h4 class="sec">1) Hitung Œª dan Œº</h4>
            <div class="math">
              \[
                \lambda = \frac{1}{\text{waktu antar kedatangan}}
              \]
              \[
                \lambda = \frac{1}{ {{ "%.6g"|format(interarrival) }} } = {{ "%.6f"|format(res.lambda) }}\ \text{pelanggan/menit}
              \]
              \[
                \mu = \frac{1}{\text{waktu pelayanan per pelayan}}
              \]
              \[
                \mu = \frac{1}{ {{ "%.6g"|format(service_time) }} } = {{ "%.6f"|format(res.mu) }}\ \text{pelanggan/menit}
              \]
            </div>

            <h4 class="sec">2) Utilisasi (œÅ)</h4>
            <div class="math">
              \[
                \rho = \frac{\lambda}{c\mu}
              \]
              \[
                \rho = \frac{ {{ "%.6f"|format(res.lambda) }} }{ 2 \times {{ "%.6f"|format(res.mu) }} } = {{ "%.6f"|format(res.rho) }}
              \]
            </div>
            <p class="plain">Utilisasi tiap pelayan ‚âà <b>{{ "%.2f"|format(res.rho*100) }}%</b></p>

            <h4 class="sec">3) Komponen Erlang-C untuk M/M/2</h4>
            <div class="math">
              \[
                a = \frac{\lambda}{\mu}
              \]
              \[
                a = \frac{ {{ "%.6f"|format(res.lambda) }} }{ {{ "%.6f"|format(res.mu) }} } = {{ "%.6f"|format(res.a) }}
              \]
              \[
                P_0 = \left[\sum_{n=0}^{c-1}\frac{a^n}{n!} + \frac{a^c}{c!}\cdot\frac{1}{1-\rho}\right]^{-1}
              \]
              \[
                P_0 = \left[1 + {{ "%.6f"|format(res.a) }} + \frac{({{ "%.6f"|format(res.a) }})^2}{2!}\cdot\frac{1}{1-{{ "%.6f"|format(res.rho) }}}\right]^{-1}
              \]
              \[
                P_0 = {{ "%.6f"|format(res.P0) }}
              \]

              \[
                L_q = P_0\cdot\frac{a^c\cdot\rho}{c!\,(1-\rho)^2}
              \]
              \[
                L_q = {{ "%.6f"|format(res.P0) }}\cdot\frac{({{ "%.6f"|format(res.a) }})^2\cdot {{ "%.6f"|format(res.rho) }}}{2!\cdot(1-{{ "%.6f"|format(res.rho) }})^2}
              \]
              \[
                L_q = {{ "%.6f"|format(res.Lq) }}
              \]

              \[
                W_q = \frac{L_q}{\lambda}
              \]
              \[
                W_q = \frac{ {{ "%.6f"|format(res.Lq) }} }{ {{ "%.6f"|format(res.lambda) }} }
              \]
              \[
                W_q = {{ "%.6f"|format(res.Wq) }}\ \text{menit}
              \]

              \[
                W = W_q + \frac{1}{\mu}
              \]
              \[
                W = {{ "%.6f"|format(res.Wq) }} + \frac{1}{ {{ "%.6f"|format(res.mu) }} }
              \]
              \[
                W = {{ "%.6f"|format(res.W) }}\ \text{menit}
              \]
            </div>
          </div>

          <div class="note">
            Catatan: Jika Bagian 1 (manual) memakai rumus Erlang-C yang sama, maka hasil manual dan aplikasi akan <b>identik</b>
            (beda hanya dari pembulatan).
          </div>
        </div>

        <div id="tab-ringkasan" class="tab-panel">
          <h2>Hasil (M/M/2)</h2>

          <div class="metrics">
            <div class="metric">
              <span>Œª (arrival rate)</span>
              <b>{{ "%.6f"|format(res.lambda) }}</b>
              <small>/ menit</small>
            </div>

            <div class="metric">
              <span>Œº (service rate)</span>
              <b>{{ "%.6f"|format(res.mu) }}</b>
              <small>/ menit</small>
            </div>

            <div class="metric">
              <span>œÅ (utilization)</span>
              <b>{{ "%.6f"|format(res.rho) }}</b>
              <small>{{ "%.2f"|format(res.rho*100) }}%</small>
            </div>

            <div class="metric">
              <span>W (time in system)</span>
              <b>{{ "%.6f"|format(res.W) }}</b>
              <small>menit</small>
            </div>

            <div class="metric">
              <span>Wq (time in queue)</span>
              <b>{{ "%.6f"|format(res.Wq) }}</b>
              <small>menit</small>
            </div>

            <div class="metric">
              <span>Lq (avg queue length)</span>
              <b>{{ "%.6f"|format(res.Lq) }}</b>
              <small>pelanggan</small>
            </div>
          </div>
        </div>

        <!-- TAMBAHAN: panel grafik -->
        <div id="tab-grafik" class="tab-panel">
          <h2>Grafik Hasil Simulasi (Variasi Œª)</h2>
          <p class="plain">
            Grafik dibuat dengan memvariasikan laju kedatangan (Œª) dari kecil hingga mendekati kapasitas sistem (‚âà95% dari 2Œº),
            lalu menghitung Wq dan W memakai rumus Erlang-C.
          </p>

          <div class="divider"></div>

          <h3>1) Wq terhadap Œª</h3>
          <canvas id="chartWq" height="120"></canvas>

          <div class="divider"></div>

          <h3>2) W terhadap Œª</h3>
          <canvas id="chartW" height="120"></canvas>

          <div class="divider"></div>

          <small class="plain">
            Catatan: ketika Œª mendekati kapasitas (œÅ ‚Üí 1), nilai Wq biasanya naik tajam.
          </small>
        </div>

        <script>
          const defaultTab = "{{ active_tab if active_tab else 'perhitungan' }}";

          // TAMBAHAN: state grafik supaya tidak render berulang
          let chartsRendered = false;
          let chartWqObj = null;
          let chartWObj = null;

          async function renderChartsIfNeeded() {
            if (chartsRendered) return;

            // pastikan Chart.js sudah kebaca
            if (typeof Chart === "undefined") {
              console.error("Chart.js belum termuat.");
              return;
            }

            const serviceTime = "{{ service_time }}";
            const c = "{{ c }}";

            const url = `/simulate?service_time=${encodeURIComponent(serviceTime)}&c=${encodeURIComponent(c)}&points=30`;

            try {
              const resp = await fetch(url);
              const payload = await resp.json();

              if (!resp.ok) {
                throw new Error(payload.error || "Gagal mengambil data simulasi.");
              }

              const pts = payload.data || [];
              const xs = pts.map(p => p.lambda);
              const wq = pts.map(p => p.Wq);
              const w = pts.map(p => p.W);

              const ctxWq = document.getElementById("chartWq");
              const ctxW = document.getElementById("chartW");

              // destroy jika pernah dibuat (jaga-jaga)
              if (chartWqObj) chartWqObj.destroy();
              if (chartWObj) chartWObj.destroy();

              chartWqObj = new Chart(ctxWq, {
                type: "line",
                data: {
                  labels: xs,
                  datasets: [{
                    label: "Wq (menit)",
                    data: wq,
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.2
                  }]
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: { display: true }
                  },
                  scales: {
                    x: {
                      title: { display: true, text: "Œª (pelanggan/menit)" }
                    },
                    y: {
                      title: { display: true, text: "Wq (menit)" },
                      beginAtZero: true
                    }
                  }
                }
              });

              chartWObj = new Chart(ctxW, {
                type: "line",
                data: {
                  labels: xs,
                  datasets: [{
                    label: "W (menit)",
                    data: w,
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.2
                  }]
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: { display: true }
                  },
                  scales: {
                    x: {
                      title: { display: true, text: "Œª (pelanggan/menit)" }
                    },
                    y: {
                      title: { display: true, text: "W (menit)" },
                      beginAtZero: true
                    }
                  }
                }
              });

              chartsRendered = true;
            } catch (err) {
              console.error(err);
              const panel = document.getElementById("tab-grafik");
              if (panel) {
                panel.insertAdjacentHTML("beforeend", `<div class="alert">${err.message}</div>`);
              }
            }
          }

          function showTab(which) {
            const p1 = document.getElementById("tab-perhitungan");
            const p2 = document.getElementById("tab-ringkasan");
            const p3 = document.getElementById("tab-grafik"); // <-- tambah
            const b1 = document.getElementById("btn-perhitungan");
            const b2 = document.getElementById("btn-ringkasan");
            const b3 = document.getElementById("btn-grafik"); // <-- tambah
            const tabInput = document.getElementById("tabInput");

            // reset display
            if (p1) p1.style.display = "none";
            if (p2) p2.style.display = "none";
            if (p3) p3.style.display = "none";

            b1.classList.remove("active");
            b2.classList.remove("active");
            b3.classList.remove("active");

            if (which === "ringkasan") {
              p2.style.display = "block";
              b2.classList.add("active");
              tabInput.value = "ringkasan";
            } else if (which === "grafik") {
              p3.style.display = "block";
              b3.classList.add("active");
              tabInput.value = "grafik";

              // TAMBAHAN: render grafik saat tab grafik dibuka
              renderChartsIfNeeded();
            } else {
              p1.style.display = "block";
              b1.classList.add("active");
              tabInput.value = "perhitungan";
            }
          }

          showTab(defaultTab);
        </script>
      {% endif %}
    </section>

    <footer class="footer-center">
      ¬© 2026 | Purnamasari Siregar ‚Äî M/M/2 Calculator
    </footer>

  </main>
</body>
</html>
